# -*- coding: utf-8 -*-
"""Untitled9.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/14ef0fU0K3nbmX8nx88-3nXu8PyjwN4_s
"""

import streamlit as st
import zipfile
import io
import requests
import re
import random

# âœ… Dropboxç›´ãƒªãƒ³ã‚¯ï¼ˆæ•´å½¢æ¸ˆã¿ï¼‰
DROPBOX_URL = "https://www.dropbox.com/scl/fi/i50xzf0isskjrle7yrcof/mp3-10.zip?rlkey=7ke725jn53j7qb0k6cfiptvtx&st=4uv4cp2y&raw=1"

# ğŸ¯ èª¬æ˜æ¬„ï¼ˆç”»é¢ä¸Šéƒ¨ã«è¡¨ç¤ºï¼‰
def show_description():
    st.title("ğŸµ Internetæ¤œå®šã€€æ¥½æ›²ç·¨")
    st.markdown("""
    ã“ã®ã‚¯ã‚¤ã‚ºã§ã¯ã€éŸ³å£°ã‚’èã„ã¦æ­£ã—ã„ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
    200å•ä»¥ä¸Šã®ä¸­ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«å…¨50å•ã€é›£æ˜“åº¦ã¯ã€Œâ˜†1ã€ã€œã€Œâ˜†4ã€ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚
    é›£æ˜“åº¦ã¯æœ¬å½“ã«é©å½“ã§ã™ã€‚å¾—ç‚¹èª¿æ•´ç›®çš„ã§ã™ã€‚
    ãƒ’ãƒ³ãƒˆã¨ã—ã¦ã€ç­”ãˆã®**æœ€åˆã®1æ–‡å­—**ãŒè¡¨ç¤ºã•ã‚Œã¾ã™

    - éŸ³å£°ã¯1å›ã®ã¿å†ç”Ÿã•ã‚Œã¾ã™ï¼ˆå†èª­ã¿è¾¼ã¿ã§ãƒªã‚»ãƒƒãƒˆï¼‰
    - ç­”ãˆã¯ã²ã‚‰ãŒãªã€ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã®å°æ–‡å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„
    - è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹è¨˜å·ã‚‚å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚åŠè§’å…¨è§’ã¯ä¸å•ã€‚
    - æ­£è§£ã™ã‚‹ã¨ã‚¹ã‚³ã‚¢ãŒåŠ ç®—ã•ã‚Œã¾ã™
    - å…¨å•çµ‚äº†å¾Œã«ã‚¹ã‚³ã‚¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™

    ğŸ¯ ç›®æŒ‡ã›å…¨å•æ­£è§£ï¼
    """)

# ğŸ” é›£æ˜“åº¦æŠ½å‡ºï¼ˆä¾‹: "god knowsã€€â˜†3.mp3" â†’ "â˜†3"ï¼‰
def extract_difficulty(filename: str) -> str:
    match = re.search(r'â˜†[1-4]', filename)
    return match.group() if match else "â˜†?"

# ğŸ§  ç­”ãˆæŠ½å‡ºï¼ˆä¾‹: "god knowsã€€â˜†3.mp3" â†’ "god knows"ï¼‰
def extract_answer(filename: str) -> str:
    base = filename.split('/')[-1].replace('.mp3', '')
    answer = re.split(r'â˜†[1-4]', base)[0].strip()
    return answer

# ğŸ’¡ ãƒ’ãƒ³ãƒˆæŠ½å‡ºï¼ˆç­”ãˆã®æœ€åˆã®1æ–‡å­—ï¼‰
def extract_hint(filename: str) -> str:
    answer = extract_answer(filename)
    return answer[0] if answer else ""

# ğŸ§ ZIPã‹ã‚‰éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
def load_audio(zip_file, filename):
    with zip_file.open(filename) as f:
        return f.read()

# ğŸ“¦ Dropboxã‹ã‚‰ZIPã‚’å–å¾—ã—ã¦ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
@st.cache_data
def load_quiz_data():
    response = requests.get(DROPBOX_URL)
    zip_bytes = io.BytesIO(response.content)
    zip_file = zipfile.ZipFile(zip_bytes)

    quiz_list = []
    for name in zip_file.namelist():
        if name.endswith('.mp3'):
            quiz_list.append({
                "filename": name,
                "answer": extract_answer(name),
                "hint": extract_hint(name),
                "difficulty": extract_difficulty(name),
                "audio": load_audio(zip_file, name)
            })

    random.shuffle(quiz_list)
    return quiz_list

# âœï¸ æ­£è¦åŒ–ï¼ˆå…¨è§’ãƒ»åŠè§’ãƒ»ç©ºç™½ãƒ»å¤§å°æ–‡å­—ã‚’å¸åï¼‰
def normalize(text: str) -> str:
    return re.sub(r'\s+', '', text.strip().lower())

# ğŸš€ Streamlitã‚¢ãƒ—ãƒªæœ¬ä½“
def main():
    show_description()
    quiz_data = load_quiz_data()

    if "index" not in st.session_state:
        st.session_state.index = 0
        st.session_state.score = 0
        st.session_state.answered = set()

    if st.session_state.index >= len(quiz_data):
        st.success("å…¨å•çµ‚äº†ï¼ãŠç–²ã‚Œã•ã¾ã§ã—ãŸã€‚")
        st.write(f"ã‚¹ã‚³ã‚¢: {st.session_state.score} / {len(quiz_data)}")
        return

    current = quiz_data[st.session_state.index]

    if current["filename"] in st.session_state.answered:
        st.session_state.index += 1
        st.experimental_rerun()

    st.audio(current["audio"], format="audio/mp3")
    st.markdown(f"**é›£æ˜“åº¦**: {current['difficulty']}")
    st.markdown(f"**ãƒ’ãƒ³ãƒˆ**: {current['hint']}")

    user_input = st.text_input("ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", key=f"input_{st.session_state.index}")

    if st.button("ç­”ãˆã‚‹", key=f"btn_{st.session_state.index}"):
        st.session_state.answered.add(current["filename"])
        if normalize(user_input) == normalize(current["answer"]):
            st.success("æ­£è§£ï¼")
            st.session_state.score += 1
        else:
            st.error(f"ä¸æ­£è§£â€¦ æ­£è§£ã¯ã€Œ{current['answer']}ã€ã§ã—ãŸ")
        st.session_state.index += 1
        st.experimental_rerun()

if __name__ == "__main__":
    main()